"""
AIdea Lab - ì•„ì´ë””ì–´ ë¶„ì„ ì›Œí¬ìˆ UI

ì´ ëª¨ë“ˆì€ Streamlitì„ ì´ìš©í•œ ì±—ë´‡ ì¸í„°í˜ì´ìŠ¤ë¥¼ ì œê³µí•©ë‹ˆë‹¤.
ì‚¬ìš©ìëŠ” ì•„ì´ë””ì–´ë¥¼ ì…ë ¥í•˜ê³  AI í˜ë¥´ì†Œë‚˜ë“¤ì˜ ë¶„ì„ ê²°ê³¼ë¥¼ ì±—ë´‡ í˜•íƒœë¡œ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
"""

import os
import sys
import asyncio
import streamlit as st
import time
from dotenv import load_dotenv
from google.adk.runners import Runner
from google.adk.sessions import InMemorySessionService
from google.genai import types

# í”„ë¡œì íŠ¸ ë£¨íŠ¸ ë””ë ‰í† ë¦¬ë¥¼ sys.pathì— ì¶”ê°€
sys.path.append(os.path.abspath(os.path.join(os.path.dirname(__file__), '../..')))
from src.orchestrator.main_orchestrator import AIdeaLabOrchestrator
from src.session_manager import SessionManager  # ìƒˆë¡œ ì¶”ê°€ëœ SessionManager import
from config.personas import PERSONA_CONFIGS, PersonaType, ORCHESTRATOR_CONFIG, PERSONA_SEQUENCE
from config.models import get_model_display_options, MODEL_CONFIGS, ModelType, DEFAULT_MODEL

# .env íŒŒì¼ì—ì„œ í™˜ê²½ ë³€ìˆ˜ ë¡œë“œ
load_dotenv()

# Streamlit í˜ì´ì§€ ì„¤ì •
st.set_page_config(
    page_title="AIdea Lab - ì•„ì´ë””ì–´ ë¶„ì„ ì›Œí¬ìˆ",
    page_icon="ğŸ§ ",
    layout="centered"  # ì±—ë´‡ UIì— ì í•©í•œ centered ë ˆì´ì•„ì›ƒ
)

# ì•± ì •ë³´
APP_NAME = "AIdea Lab"
USER_ID = "streamlit_user"

# ì„¸ì…˜ ê´€ë¦¬ì ì´ˆê¸°í™”
session_manager = SessionManager(APP_NAME, USER_ID)

# ì‹œìŠ¤í…œ ì•ˆë‚´ ë©”ì‹œì§€ í…œí”Œë¦¿ ì •ì˜
SYSTEM_MESSAGES = {
    "welcome": "**AIdea Labì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤.** ë‹¹ì‹ ì˜ ì•„ì´ë””ì–´ë¥¼ ì…ë ¥í•˜ì‹œë©´ AI í˜ë¥´ì†Œë‚˜ë“¤ì´ ë‹¤ì–‘í•œ ê´€ì ì—ì„œ ë¶„ì„í•´ë“œë¦½ë‹ˆë‹¤.",
    "phase1_start": "**ë¶„ì„ì„ ì‹œì‘í•©ë‹ˆë‹¤.** ê° AI í˜ë¥´ì†Œë‚˜ê°€ ìˆœì°¨ì ìœ¼ë¡œ ì˜ê²¬ì„ ì œì‹œí•  ì˜ˆì •ì…ë‹ˆë‹¤.",
    "marketer_intro": "**ğŸ” ì•„ì´ë””ì–´ ë§ˆì¼€íŒ… ë¶„ì„ê°€ì˜ ì˜ê²¬:**",
    "critic_intro": "**âš ï¸ ë¹„íŒì  ë¶„ì„ê°€ì˜ ì˜ê²¬:**", 
    "engineer_intro": "**âš™ï¸ ì—”ì§€ë‹ˆì–´ì˜ ì˜ê²¬:**",
    "summary_intro": "**ğŸ“ ìµœì¢… ìš”ì•½ ë° ì¢…í•©:**",
    "phase1_complete": "**ë¶„ì„ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.** ë” ê¹Šì´ ì•Œì•„ë³´ì‹œë ¤ë©´ ë‹¤ìŒ ë‹¨ê³„ë¡œ ì§„í–‰í•´ì£¼ì„¸ìš”.",
    "phase1_error": "**ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.** ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”."
}

# í˜ë¥´ì†Œë‚˜ ì•„ë°”íƒ€ ì •ì˜
persona_avatars = {
    "marketer": "ğŸ’¡",
    "critic": "ğŸ”",
    "engineer": "âš™ï¸",
    "summary_agent_phase1": "ğŸ“"
}

print(f"Initialized persona avatars: {persona_avatars}")

class ADKRunner:
    """Google ADK ì—ì´ì „íŠ¸ ì‹¤í–‰ì„ ìœ„í•œ ë˜í¼ í´ë˜ìŠ¤"""
    
    def __init__(self, workflow):
        """ì´ˆê¸°í™” í•¨ìˆ˜"""
        self.workflow = workflow
    
    async def run(self):
        """ì—ì´ì „íŠ¸ ì‹¤í–‰ ë° ì´ë²¤íŠ¸ ìŠ¤íŠ¸ë¦¼ ìƒì„±"""
        print("ADKRunner.run() called")
        # ì—¬ê¸°ì„œëŠ” ì‹¤ì œ ADK ì´ë²¤íŠ¸ë¥¼ ì‹œë®¬ë ˆì´ì…˜í•©ë‹ˆë‹¤
        # ì‹¤ì œ êµ¬í˜„ì—ì„œëŠ” ADK ì´ë²¤íŠ¸ë¥¼ yieldí•˜ëŠ” ì½”ë“œë¡œ ëŒ€ì²´ë©ë‹ˆë‹¤
        await asyncio.sleep(0.5)  # ì‹œë®¬ë ˆì´ì…˜ ì§€ì—°
        yield type('Event', (), {'agent_name': 'marketer_agent', 'is_final_response': lambda: True, 'payload': {'content': 'ë§ˆì¼€í„° ì‘ë‹µ'}})
        await asyncio.sleep(0.5)
        yield type('Event', (), {'agent_name': 'critic_agent', 'is_final_response': lambda: True, 'payload': {'content': 'ë¹„í‰ê°€ ì‘ë‹µ'}})
        await asyncio.sleep(0.5)
        yield type('Event', (), {'agent_name': 'engineer_agent', 'is_final_response': lambda: True, 'payload': {'content': 'ì—”ì§€ë‹ˆì–´ ì‘ë‹µ'}})
        await asyncio.sleep(0.5)
        yield type('Event', (), {'agent_name': 'summary_agent', 'is_final_response': lambda: True, 'payload': {'content': 'ìš”ì•½ ì‘ë‹µ'}})
        await asyncio.sleep(0.5)
        yield type('Event', (), {'agent_name': 'phase1_workflow', 'is_final_response': lambda: True})

# í…ìŠ¤íŠ¸ë¥¼ ë‹¨ì–´ ë‹¨ìœ„ë¡œ ìŠ¤íŠ¸ë¦¬ë°í•˜ëŠ” í•¨ìˆ˜
def stream_text(text):
    """
    í…ìŠ¤íŠ¸ë¥¼ ë‹¨ì–´ ë‹¨ìœ„ë¡œ ìŠ¤íŠ¸ë¦¬ë°í•˜ëŠ” ì œë„ˆë ˆì´í„° í•¨ìˆ˜
    
    Args:
        text (str): ìŠ¤íŠ¸ë¦¬ë°í•  í…ìŠ¤íŠ¸
        
    Yields:
        str: ë‹¨ì–´ ë‹¨ìœ„ë¡œ ìŠ¤íŠ¸ë¦¬ë°ëœ í…ìŠ¤íŠ¸
    """
    words = text.split(' ')
    result = ""
    for word in words:
        result += word + " "
        time.sleep(0.05)  # ë‹¨ì–´ ì‚¬ì´ì— ì•½ê°„ì˜ ì§€ì—° ì¶”ê°€
        yield result

def run_phase1_analysis_and_update_ui():
    """
    ì•„ì´ë””ì–´ ë¶„ì„ì„ ì‹¤í–‰í•˜ê³  UIë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
    ì´ í•¨ìˆ˜ëŠ” st.session_state.current_ideaê°€ ì„¤ì •ë˜ì–´ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.
    """
    try:
        # ë¡œì»¬ ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´í„° ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
        orchestrator = AIdeaLabOrchestrator(model_name=st.session_state.selected_model)
        print(f"Created local orchestrator with model: {st.session_state.selected_model}")
        
        # ë¶„ì„ ìƒíƒœ ì„¤ì •
        st.session_state.analysis_phase = "phase1_running"
        st.session_state.analysis_step = "starting"
        
        # ë¶„ì„ ì‹œì‘ ë©”ì‹œì§€ ì €ì¥
        show_system_message("phase1_start")
        print("Phase 1 analysis started")
        
        # ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        idea_text = st.session_state.current_idea
        user_goal = st.session_state.user_goal if hasattr(st.session_state, "user_goal") else None
        user_constraints = st.session_state.user_constraints if hasattr(st.session_state, "user_constraints") else None
        user_values = st.session_state.user_values if hasattr(st.session_state, "user_values") else None
        print(f"Analyzing idea: {idea_text}")
        print(f"User info - Goal: {user_goal}, Constraints: {user_constraints}, Values: {user_values}")
        
        # ìƒˆ ì„¸ì…˜ ì‹œì‘ - ë°˜í™˜ê°’ ì˜¬ë°”ë¥´ê²Œ ì–¸íŒ¨í‚¹
        session_object, session_id_string = session_manager.start_new_idea_session(
            idea_text,
            user_goal=user_goal,
            user_constraints=user_constraints,
            user_values=user_values
        )
        
        # ë””ë²„ê¹…ìš© ë¡œê¹… - ì„¸ì…˜ ê°ì²´ì™€ ID í™•ì¸
        print(f"Session object type: {type(session_object).__name__}")
        print(f"Session ID string type: {type(session_id_string).__name__}, value: {session_id_string}")
        
        st.session_state.adk_session_id = session_id_string  # ë¬¸ìì—´ ì„¸ì…˜ IDë§Œ ì €ì¥
        print(f"Created new session with ID: {session_id_string}")
        
        # ì›Œí¬í”Œë¡œìš° ì—ì´ì „íŠ¸ ê°€ì ¸ì˜¤ê¸°
        phase1_workflow_agent = orchestrator.get_phase1_workflow()
        print(f"Successfully retrieved phase1_workflow_agent using get_phase1_workflow()")
        
        # ëŸ¬ë„ˆ ì´ˆê¸°í™”
        try:
            runner = Runner(
                agent=phase1_workflow_agent,
                app_name=APP_NAME,
                session_service=session_manager.session_service
            )
            print(f"Successfully initialized Runner with agent, app_name={APP_NAME}, and session_service")
        except Exception as e:
            print(f"ERROR initializing Runner: {str(e)}")
            import traceback
            traceback.print_exc()
            st.session_state.analysis_phase = "phase1_error"
            st.session_state.analysis_step = "error"
            show_system_message("phase1_error")
            st.session_state.need_rerun = True
            return
        
        # ë¹„ë™ê¸° í•¨ìˆ˜ _run_phase1_analysis ì •ì˜
        async def _run_phase1_analysis(runner, session_id_string, content, orchestrator, phase1_workflow_agent_name):
            print(f"DEBUG: _run_phase1_analysis - Starting with session_id: {session_id_string}, Workflow Agent Name: {phase1_workflow_agent_name}")
            
            try:
                output_keys_map = orchestrator.get_output_keys_phase1() # .items() ì•ˆí•´ë„ ë¨
                print(f"DEBUG: _run_phase1_analysis - Output keys map from orchestrator: {output_keys_map}")
                
                event_stream = runner.run_async(
                    user_id=USER_ID,
                    session_id=session_id_string,
                    new_message=content
                )
                
                workflow_completed_event_received = False
                all_responses_found_in_final_state = False # ìµœì¢… ìƒíƒœì—ì„œ ëª¨ë“  ì‘ë‹µì´ ë°œê²¬ë˜ì—ˆëŠ”ì§€
                
                async for event in event_stream:
                    print(f"DEBUG: _run_phase1_analysis - Event Received: Type={type(event).__name__}, Details={str(event)[:500]}...") # ë„ˆë¬´ ê¸´ ì´ë²¤íŠ¸ëŠ” ì¼ë¶€ë§Œ ë¡œê¹…
                    
                    agent_name = getattr(event, 'agent_name', None)
                    is_final = hasattr(event, 'is_final_response') and event.is_final_response()

                    if agent_name and is_final:
                        print(f"DEBUG: Final response detected for agent: {agent_name}")
                        if hasattr(event, 'actions') and hasattr(event.actions, 'state_delta') and event.actions.state_delta:
                            print(f"DEBUG: State delta for {agent_name}: {event.actions.state_delta}")
                        
                        # SequentialAgent ì „ì²´ì˜ ì‹¤í–‰ ì™„ë£Œ í™•ì¸
                        if agent_name == phase1_workflow_agent_name:
                            print(f"DEBUG: _run_phase1_analysis - Workflow COMPLETED event for: {agent_name}")
                            workflow_completed_event_received = True
                            # ì—¬ê¸°ì„œ break í•˜ê¸° ì „ì— ìµœì¢… ìƒíƒœë¥¼ í™•ì¸í•˜ëŠ” ê²ƒì´ ì¤‘ìš”
                            final_session = session_manager.get_session(session_id_string)
                            if final_session and hasattr(final_session, 'state'):
                                print("== FINAL SESSION STATE (within _run_phase1_analysis after workflow completion event) ==")
                                final_state = final_session.state
                                final_keys = sorted(final_state.keys())
                                print(f"Final session keys: {final_keys}")
                                
                                temp_responses_found = True # ì´ë²ˆ ê²€ì¦ì—ì„œì˜ ì„±ê³µ ì—¬ë¶€
                                for persona_key, output_key_value in output_keys_map.items():
                                    if output_key_value in final_state:
                                        val = final_state.get(output_key_value)
                                        val_prev = str(val)[:50] + "..." if val and len(str(val)) > 50 else str(val)
                                        print(f"  Key '{output_key_value}' for '{persona_key}': FOUND, Value: {val_prev}")
                                        if not val or (isinstance(val, str) and len(str(val).strip()) < 10):
                                            print(f"  WARNING: Empty or very short value for '{output_key_value}'")
                                            temp_responses_found = False
                                    else:
                                        print(f"  Key '{output_key_value}' for '{persona_key}': MISSING in final state")
                                        temp_responses_found = False
                                all_responses_found_in_final_state = temp_responses_found # ìµœì¢… ê²°ê³¼ ì—…ë°ì´íŠ¸
                                print("== END FINAL SESSION STATE (within _run_phase1_analysis) ==")
                            else:
                                print("ERROR: _run_phase1_analysis - Could not retrieve final session or session has no state after workflow completion event.")
                                all_responses_found_in_final_state = False
                            break # ì›Œí¬í”Œë¡œìš° ì™„ë£Œ ì´ë²¤íŠ¸ ìˆ˜ì‹  í›„ ë£¨í”„ ì¢…ë£Œ
                
                print(f"DEBUG: _run_phase1_analysis - Event stream processing finished. Workflow completed event received: {workflow_completed_event_received}, All responses found in final state: {all_responses_found_in_final_state}")
                
                # SequentialAgent ì™„ë£Œ ì´ë²¤íŠ¸ê°€ ìˆ˜ì‹ ë˜ì—ˆê³ , ê·¸ ìƒíƒœì—ì„œ ëª¨ë“  ì‘ë‹µì´ ë°œê²¬ëœ ê²½ìš°ì—ë§Œ True ë°˜í™˜
                return workflow_completed_event_received and all_responses_found_in_final_state
                    
            except Exception as e:
                print(f"ERROR in _run_phase1_analysis: {str(e)}")
                import traceback
                traceback.print_exc()
                return False

        try:
            print("Starting analysis run...")
            print(f"Phase 1 workflow agent: {phase1_workflow_agent}")
            
            # ì…ë ¥ ì»¨í…ì¸  ì„¤ì •
            content = types.Content(
                role="user",
                parts=[types.Part(text=f"ì•„ì´ë””ì–´: {idea_text}\nëª©í‘œ: {user_goal}\nì œì•½ì¡°ê±´: {user_constraints}\nê°€ì¹˜: {user_values}")]
            )
            
            print(f"Prepared content for runner.run() - Idea: {idea_text}")
            print(f"Content object: {content}")
            
            # ë¹„ë™ê¸° í•¨ìˆ˜ _run_phase1_analysis ì‹¤í–‰ (asyncio.runìœ¼ë¡œ ë™ê¸°ì  ì‹¤í–‰ í™˜ê²½ì—ì„œ í˜¸ì¶œ)
            print("Starting _run_phase1_analysis with proper parameters...")
            analysis_success = asyncio.run(_run_phase1_analysis(
                runner, 
                session_id_string, 
                content, 
                orchestrator, 
                phase1_workflow_agent.name
            ))
            
            # ì›Œí¬í”Œë¡œìš° ì™„ë£Œ í›„ ìµœì‹  ì„¸ì…˜ ìƒíƒœì—ì„œ ê²°ê³¼ ì¶”ì¶œ
            if analysis_success:
                print("Retrieving results from session state...")
                current_session = session_manager.get_session(session_id_string)  # ë¬¸ìì—´ ì„¸ì…˜ ID ì‚¬ìš©
                if not current_session:
                    print("ERROR: Session not found after workflow completion")
                    analysis_success = False
                else:
                    # ì„¸ì…˜ ìƒíƒœ ë¤í”„ (ë””ë²„ê¹…ìš©)
                    print("== SESSION STATE DUMP ==")
                    state_keys = sorted(current_session.state.keys())
                    print(f"Session state keys after workflow: {state_keys}")
                    for key in state_keys:
                        value = current_session.state.get(key)
                        value_type = type(value).__name__
                        preview = str(value)[:100] + "..." if isinstance(value, str) and len(str(value)) > 100 else str(value)
                        print(f"SESSION STATE: KEY={key}, TYPE={value_type}, PREVIEW={preview}")
                    print("== END SESSION STATE DUMP ==")
                    
                    # ì¶œë ¥ í‚¤ ê°€ì ¸ì˜¤ê¸°
                    output_keys = orchestrator.get_output_keys_phase1()
                    print(f"Output keys from orchestrator: {output_keys}")
                    
                    # ì¶œë ¥ í‚¤ ìƒì„¸ ê²€ì‚¬
                    print("== OUTPUT KEYS DETAILED CHECK ==")
                    for persona_key, output_key in output_keys.items():
                        if output_key in current_session.state:
                            value = current_session.state.get(output_key)
                            print(f"OUTPUT KEY FOUND: {output_key} for {persona_key}, Value length: {len(str(value)) if value else 0}")
                            if not value or (isinstance(value, str) and len(value.strip()) < 10):
                                print(f"WARNING: Output key {output_key} has empty or very short value: '{value}'")
                        else:
                            print(f"MISSING OUTPUT KEY: {output_key} for {persona_key}")
                    print("== END OUTPUT KEYS DETAILED CHECK ==")
                    
                    # config/personas.pyì˜ PERSONA_SEQUENCE ìˆœì„œì— ë”°ë¥¸ í˜ë¥´ì†Œë‚˜ ëª©ë¡
                    # ë§ˆì¼€í„° -> ë¹„íŒì  ë¶„ì„ê°€ -> ì—”ì§€ë‹ˆì–´ -> ìš”ì•½
                    personas = [
                        ("marketer", "marketer_intro", persona_avatars.get("marketer", "ğŸ’¡")),
                        ("critic", "critic_intro", persona_avatars.get("critic", "ğŸ”")),
                        ("engineer", "engineer_intro", persona_avatars.get("engineer", "âš™ï¸")),
                        ("summary_phase1", "summary_intro", persona_avatars.get("summary_agent_phase1", "ğŸ“"))
                    ]
                    
                    # ì‘ë‹µì„ ì°¾ì•˜ëŠ”ì§€ ì¶”ì 
                    responses_found = False
                    
                    # ê°„ë‹¨í•˜ê²Œ ê²°ê³¼ ì¶”ì¶œ ë° ë©”ì‹œì§€ ì¶”ê°€
                    for persona_key, intro_message, avatar in personas:
                        # ì¶œë ¥ í‚¤ í™•ì¸
                        output_key = output_keys.get(persona_key)
                        if not output_key:
                            print(f"WARNING: No output key defined for {persona_key}")
                            continue
                            
                        # ì„¸ì…˜ ìƒíƒœì—ì„œ ì‘ë‹µ ê°€ì ¸ì˜¤ê¸°
                        if output_key in current_session.state:
                            response = current_session.state.get(output_key)
                            if response and isinstance(response, str) and len(response) > 50:  # ìœ íš¨í•œ ì‘ë‹µì¸ì§€ í™•ì¸
                                # ì‹œìŠ¤í…œ ì†Œê°œ ë©”ì‹œì§€ ì¶”ê°€
                                show_system_message(intro_message)
                                # ì‹¤ì œ í˜ë¥´ì†Œë‚˜ ì‘ë‹µ ì¶”ê°€
                                add_message("assistant", process_text_for_display(response), avatar=avatar)
                                print(f"Added {persona_key} response with key {output_key} from session state")
                                responses_found = True
                            else:
                                print(f"WARNING: Empty or invalid response for {persona_key} with key {output_key}: {response}")
                        else:
                            print(f"WARNING: Output key '{output_key}' not found in session state")
                            
                            # ì¶”ê°€ ê²€ìƒ‰: í‚¤ ì´ë¦„ì´ ì¼ë¶€ í¬í•¨ëœ ê²½ìš° ì°¾ê¸° ì‹œë„
                            for key in state_keys:
                                if persona_key.lower() in key.lower():
                                    value = current_session.state.get(key)
                                    if isinstance(value, str) and len(value) > 50:
                                        print(f"Found potential match for {persona_key}: {key}")
                                        show_system_message(intro_message)
                                        add_message("assistant", process_text_for_display(value), avatar=avatar)
                                        print(f"Added {persona_key} response with alternative key {key}")
                                        responses_found = True
                                        break
                    
                    # ì‘ë‹µì„ ì°¾ì§€ ëª»í•œ ê²½ìš°
                    if not responses_found:
                        print("WARNING: No responses found in session state")
                        show_system_message("phase1_error")
                        analysis_success = False
                    else:
                        # ë¶„ì„ ì™„ë£Œ ë©”ì‹œì§€ ì¶”ê°€
                        show_system_message("phase1_complete")
                    
                    # st.session_state.messages ë‚´ìš© ë””ë²„ê¹… ë¡œê·¸
                    print("== MESSAGES STATE DUMP ==")
                    print(f"Messages count: {len(st.session_state.messages)}")
                    for i, msg in enumerate(st.session_state.messages):
                        msg_role = msg.get("role", "unknown")
                        msg_avatar = msg.get("avatar", "none")
                        msg_content_preview = str(msg.get("content", ""))[:50] + "..." if len(str(msg.get("content", ""))) > 50 else str(msg.get("content", ""))
                        print(f"Message #{i}: Role={msg_role}, Avatar={msg_avatar}, Content preview: {msg_content_preview}")
                    print("== END MESSAGES STATE DUMP ==")
            
            # ë¶„ì„ì´ ì‹¤íŒ¨í•œ ê²½ìš°
            if not analysis_success:
                print("Analysis was not successful")
                # ì˜¤ë¥˜ ìƒíƒœ ì„¤ì •
                st.session_state.analysis_phase = "phase1_error"
                st.session_state.analysis_step = "error"
                show_system_message("phase1_error")
            else:
                # ì„±ê³µí•œ ê²½ìš° ìµœì¢… ìƒíƒœ ì„¤ì •
                st.session_state.analysis_phase = "phase1_complete"
                st.session_state.analysis_step = "complete"
            
            # UI ê°±ì‹  ì¤€ë¹„
            st.session_state.need_rerun = True
            print("Analysis completed. UI will be updated on next rerun.")
            
            # ì¢…ë£Œ ì‹œ ìƒíƒœ ìš”ì•½ ë¡œê·¸
            print(f"=== ANALYSIS RESULT SUMMARY ===")
            print(f"Analysis status: {'SUCCESS' if analysis_success else 'FAILED'}")
            print(f"Messages count: {len(st.session_state.messages)}")
            print(f"Analysis phase: {st.session_state.analysis_phase}")
            print(f"Need rerun: {st.session_state.need_rerun}")
            print(f"=============================")
            
        except Exception as e:
            print(f"Error during analysis execution: {str(e)}")
            import traceback
            traceback.print_exc()
            
            # ì˜¤ë¥˜ ìƒíƒœ ì„¤ì •
            st.session_state.analysis_phase = "phase1_error"
            st.session_state.analysis_step = "error"
            show_system_message("phase1_error")
            st.session_state.need_rerun = True
            
    except Exception as e:
        print(f"Error during orchestrator or runner setup: {str(e)}")
        import traceback
        traceback.print_exc()
        
        # ì˜¤ë¥˜ ìƒíƒœ ì„¤ì •
        st.session_state.analysis_phase = "phase1_error"
        st.session_state.analysis_step = "error"
        show_system_message("phase1_error")
        st.session_state.need_rerun = True

def initialize_session_state():
    """ì„¸ì…˜ ìƒíƒœ ì´ˆê¸°í™”"""
    if 'session_counter' not in st.session_state:
        st.session_state.session_counter = 0
    
    # ì„ íƒëœ ëª¨ë¸ ì„¸ì…˜ ìƒíƒœ ì´ˆê¸°í™”
    if 'selected_model' not in st.session_state:
        st.session_state.selected_model = DEFAULT_MODEL.value
    
    # ì±„íŒ… ê´€ë ¨ ì„¸ì…˜ ìƒíƒœ ì´ˆê¸°í™”
    if 'messages' not in st.session_state:
        st.session_state.messages = [] # {"role": "user/assistant/system", "content": "...", "avatar": "ğŸ§‘â€ğŸ’»/ğŸ§ /âš™ï¸"}
        # ì´ˆê¸° í™˜ì˜ ë©”ì‹œì§€ ì¶”ê°€ (ë©”ì‹œì§€ ì´ˆê¸°í™” ì‹œ í•œ ë²ˆë§Œ ì¶”ê°€)
        try:
            welcome_message = SYSTEM_MESSAGES.get("welcome", "AIdea Labì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤.")
            add_message("assistant", welcome_message, avatar="âš™ï¸")
        except Exception as e:
            print(f"í™˜ì˜ ë©”ì‹œì§€ ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {str(e)}")
            # ë°±ì—… í™˜ì˜ ë©”ì‹œì§€ ì¶”ê°€
            add_message("assistant", "AIdea Labì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤.", avatar="âš™ï¸")
    
    # ì•„ì´ë””ì–´ ë° ë¶„ì„ ìƒíƒœ
    if 'current_idea' not in st.session_state: # ì‚¬ìš©ìê°€ í˜„ì¬ ì…ë ¥í•œ ì•„ì´ë””ì–´ (ë¶„ì„ ì „)
        st.session_state.current_idea = ""
    if 'analyzed_idea' not in st.session_state: # ë¶„ì„ì´ ì™„ë£Œëœ ì•„ì´ë””ì–´ (ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€ìš©)
        st.session_state.analyzed_idea = ""
    if 'analysis_phase' not in st.session_state: # "idle", "phase1_running", "phase1_complete", "phase2_running", ...
        st.session_state.analysis_phase = "idle"
    if 'phase1_step' not in st.session_state: # 1ë‹¨ê³„ ë¶„ì„ì˜ ì„¸ë¶€ ìƒíƒœ ("awaiting_idea", "idea_submitted", "analysis_started", ...)
        st.session_state.phase1_step = "awaiting_idea"
    if 'adk_session_id' not in st.session_state:
        st.session_state.adk_session_id = None
    if 'user_goal' not in st.session_state: # ì‚¬ìš©ì ì¶”ê°€ ì •ë³´
        st.session_state.user_goal = ""
    if 'user_constraints' not in st.session_state: # ì‚¬ìš©ì ì œì•½ ì¡°ê±´
        st.session_state.user_constraints = ""
    if 'user_values' not in st.session_state: # ì‚¬ìš©ì ì¤‘ìš” ê°€ì¹˜
        st.session_state.user_values = ""
    if 'show_additional_info' not in st.session_state: # ì¶”ê°€ ì •ë³´ ì…ë ¥ í•„ë“œ í‘œì‹œ ì—¬ë¶€
        st.session_state.show_additional_info = False
    if 'expander_state' not in st.session_state: # expander ì˜¤í”ˆ ìƒíƒœ ìœ ì§€
        st.session_state.expander_state = True
    if 'need_rerun' not in st.session_state: # rerun í•„ìš” ì—¬ë¶€ í”Œë˜ê·¸
        st.session_state.need_rerun = False

def update_setting(key, value):
    """
    ì„¤ì •ì„ ì—…ë°ì´íŠ¸í•˜ëŠ” í•¨ìˆ˜
    
    Args:
        key (str): ì—…ë°ì´íŠ¸í•  ì„¤ì • í‚¤
        value: ì„¤ì •í•  ê°’
    """
    # ì„¤ì • ì—…ë°ì´íŠ¸
    setattr(st.session_state, key, value)
    # UI ì—…ë°ì´íŠ¸ í”Œë˜ê·¸ ì„¤ì •
    st.session_state.need_rerun = True

def restart_session(keep_messages=False):
    """
    ì• í”Œë¦¬ì¼€ì´ì…˜ ì„¸ì…˜ì„ ì¬ì‹œì‘í•©ë‹ˆë‹¤.
    
    Args:
        keep_messages (bool): ë©”ì‹œì§€ íˆìŠ¤í† ë¦¬ ìœ ì§€ ì—¬ë¶€
    """
    print("Restarting session...")
    
    # ë©”ì‹œì§€ ì €ì¥ (keep_messagesê°€ Trueì¼ ê²½ìš°)
    messages_backup = None
    if keep_messages and 'messages' in st.session_state:
        messages_backup = st.session_state.messages.copy()
    
    # ë¶„ì„ ê´€ë ¨ ìƒíƒœ ì´ˆê¸°í™”
    st.session_state.current_idea = ""
    st.session_state.analyzed_idea = ""
    st.session_state.analysis_phase = "idle"
    st.session_state.phase1_step = "awaiting_idea"
    st.session_state.adk_session_id = None
    
    # í•„ìš”í•œ ê²½ìš° ë©”ì‹œì§€ ë³µì›
    if keep_messages and messages_backup:
        st.session_state.messages = messages_backup
    elif not keep_messages:
        # ë©”ì‹œì§€ë¥¼ ìœ ì§€í•˜ì§€ ì•ŠëŠ” ê²½ìš° ë©”ì‹œì§€ ì´ˆê¸°í™”
        st.session_state.messages = []
        # í™˜ì˜ ë©”ì‹œì§€ ë‹¤ì‹œ ì¶”ê°€
        try:
            welcome_message = SYSTEM_MESSAGES.get("welcome", "AIdea Labì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤.")
            add_message("assistant", welcome_message, avatar="âš™ï¸")
        except Exception as e:
            print(f"í™˜ì˜ ë©”ì‹œì§€ ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {str(e)}")
            add_message("assistant", "AIdea Labì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤.", avatar="âš™ï¸")
    
    print("Session restart completed.")

def main():
    """
    ë©”ì¸ UI ë¡œì§
    """
    # ì„¸ì…˜ ìƒíƒœ ì´ˆê¸°í™”
    initialize_session_state()
    
    # ìƒë‹¨ í—¤ë” ì„¤ì •
    st.title("AIdea Lab - ì•„ì´ë””ì–´ ê²€ì¦ ë„êµ¬")
    st.markdown("ë‹¹ì‹ ì˜ ì•„ì´ë””ì–´ë¥¼ AIê°€ ë‹¤ì–‘í•œ ê´€ì ì—ì„œ ë¶„ì„í•´ë“œë¦½ë‹ˆë‹¤!")
    
    # AI ëª¨ë¸ ì„ íƒ UI
    model_col1, model_col2 = st.columns([3, 1])
    with model_col1:
        try:
            model_options = [model.value for model in ModelType]
            default_index = model_options.index(st.session_state.selected_model) if st.session_state.selected_model in model_options else 0
            selected_model = st.selectbox(
                "AI ëª¨ë¸ ì„ íƒ",
                options=model_options,
                index=default_index,
                key="model_selector"
            )
        except Exception as e:
            print(f"ëª¨ë¸ ì„ íƒ UI ìƒì„± ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {str(e)}")
            selected_model = DEFAULT_MODEL.value
            st.selectbox(
                "AI ëª¨ë¸ ì„ íƒ",
                options=[DEFAULT_MODEL.value],
                index=0,
                key="model_selector"
            )
    with model_col2:
        if st.button("ëª¨ë¸ ì ìš©", key="apply_model"):
            # ì„ íƒëœ ëª¨ë¸ ì €ì¥
            st.session_state.selected_model = selected_model
            print(f"Model changed to: {selected_model}")
            
            # ì„¸ì…˜ ì¬ì‹œì‘ (ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´í„°ëŠ” run_phase1_analysis_and_update_uiì—ì„œ ìƒì„±ë¨)
            restart_session()
            st.session_state.need_rerun = True
    
    # ì±„íŒ… ë©”ì‹œì§€ í‘œì‹œ (ë‹¨ì¼ ë£¨í”„ë¡œ ëª¨ë“  ë©”ì‹œì§€ ë Œë”ë§)
    messages_container = st.container()
    with messages_container:
        # ì„¸ì…˜ ìƒíƒœì— ì €ì¥ëœ ë©”ì‹œì§€ë“¤ í‘œì‹œ
        if st.session_state.messages:
            for message in st.session_state.messages:
                role = message.get("role", "")
                content = message.get("content", "")
                avatar = message.get("avatar", None)
                print(f"Rendering message - Role: {role}, Avatar: {avatar}, Content preview: {content[:50]}...")
                
                if role == "user":
                    st.chat_message(role, avatar="ğŸ§‘â€ğŸ’»").write(content)
                elif role == "assistant":
                    st.chat_message(role, avatar=avatar).write(content)
                elif role == "system":
                    st.info(content)
    
    # ì…ë ¥ UI ë¶€ë¶„
    input_container = st.container()
    with input_container:
        # ì•„ì´ë””ì–´ ìƒíƒœì— ë”°ë¥¸ UI í‘œì‹œ
        if st.session_state.analysis_phase == "idle":
            # ì¶”ê°€ ì •ë³´ ì…ë ¥ ë²„íŠ¼
            if st.button("ì¶”ê°€ ì •ë³´ ì…ë ¥", key="toggle_additional_info"):
                st.session_state.show_additional_info = not st.session_state.show_additional_info
                st.session_state.expander_state = True  # í¼ì¹¨ ìƒíƒœë¡œ ì´ˆê¸°í™”
                st.session_state.need_rerun = True
            
            # ì¶”ê°€ ì •ë³´ ì…ë ¥ í¼ í‘œì‹œ (í† ê¸€ ìƒíƒœì— ë”°ë¼)
            if st.session_state.show_additional_info:
                with st.expander("ì¶”ê°€ ì •ë³´", expanded=st.session_state.expander_state):
                    st.text_area("ëª©í‘œ ë˜ëŠ” ë¬¸ì œ ì •ì˜", key="user_goal", 
                              placeholder="ì´ ì•„ì´ë””ì–´ë¡œ í•´ê²°í•˜ë ¤ëŠ” ëª©í‘œë‚˜ ë¬¸ì œëŠ” ë¬´ì—‡ì¸ê°€ìš”?",
                              on_change=lambda: update_setting("expander_state", True))
                    st.text_area("ì œì•½ ì¡°ê±´", key="user_constraints", 
                              placeholder="ê³ ë ¤í•´ì•¼ í•  ì œì•½ ì¡°ê±´ì´ ìˆë‚˜ìš”? (ì˜ˆì‚°, ì‹œê°„, ê¸°ìˆ ì  ì œì•½ ë“±)",
                              on_change=lambda: update_setting("expander_state", True))
                    st.text_area("ì¤‘ìš” ê°€ì¹˜", key="user_values", 
                              placeholder="ì´ ì•„ì´ë””ì–´ì—ì„œ ì¤‘ìš”ì‹œí•˜ëŠ” ê°€ì¹˜ëŠ” ë¬´ì—‡ì¸ê°€ìš”? (íš¨ìœ¨ì„±, ì°½ì˜ì„±, ì‚¬ìš©ì„± ë“±)",
                              on_change=lambda: update_setting("expander_state", True))
            
            # ì•„ì´ë””ì–´ ì…ë ¥ì°½
            user_input = st.chat_input("ì•„ì´ë””ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”")
            if user_input:
                # ì‚¬ìš©ì ë©”ì‹œì§€ ì¶”ê°€
                add_message("user", user_input)
                # í˜„ì¬ ì•„ì´ë””ì–´ ì €ì¥
                st.session_state.current_idea = user_input
                # ë¶„ì„ ì¤€ë¹„ ìƒíƒœë¡œ ë³€ê²½
                st.session_state.analysis_phase = "phase1_pending_start"
                st.session_state.need_rerun = True
        
        # ë¶„ì„ ì‹œì‘ ëŒ€ê¸° ìƒíƒœ
        elif st.session_state.analysis_phase == "phase1_pending_start":
            # ë¶„ì„ ì‹¤í–‰ ìŠ¤í”¼ë„ˆ í‘œì‹œ
            with st.spinner("AI í˜ë¥´ì†Œë‚˜ê°€ ì•„ì´ë””ì–´ë¥¼ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤..."):
                print("Starting Phase 1 analysis...")
                # ë¶„ì„ ì‹¤í–‰
                run_phase1_analysis_and_update_ui()
                # UIëŠ” main í•¨ìˆ˜ ë§ˆì§€ë§‰ì—ì„œ ì¼ì›í™”í•˜ì—¬ rerun í•¨
        
        # 1ë‹¨ê³„ ë¶„ì„ ì™„ë£Œ í›„ UI
        elif st.session_state.analysis_phase == "phase1_complete":
            if st.button("ë‹¤ë¥¸ ì•„ì´ë””ì–´ ë¶„ì„í•˜ê¸°", key="new_idea"):
                restart_session(keep_messages=True)
                st.session_state.need_rerun = True
            
            # ì¶”ê°€ ê¸°ëŠ¥ì„ ìœ„í•œ ë²„íŠ¼ë“¤
            col1, col2, col3 = st.columns(3)
            with col1:
                if st.button("2ë‹¨ê³„ ë¶„ì„ (ì¤€ë¹„ì¤‘)", key="phase2", disabled=True):
                    pass
            with col2:
                if st.button("ì•„ì´ë””ì–´ ì €ì¥ (ì¤€ë¹„ì¤‘)", key="save_idea", disabled=True):
                    pass
            with col3:
                if st.button("ê²°ê³¼ ê³µìœ  (ì¤€ë¹„ì¤‘)", key="share_result", disabled=True):
                    pass
        
        # ì˜¤ë¥˜ ë°œìƒì‹œ UI
        elif st.session_state.analysis_phase == "phase1_error":
            if st.button("ë‹¤ì‹œ ì‹œë„í•˜ê¸°", key="retry"):
                restart_session(keep_messages=True)
                st.session_state.need_rerun = True
            
            if st.button("ì²˜ìŒë¶€í„° ë‹¤ì‹œí•˜ê¸°", key="restart"):
                restart_session(keep_messages=False)
                st.session_state.need_rerun = True
    
    # í•„ìš”í•œ ê²½ìš° UI ë¦¬ë¡œë“œ (ëª¨ë“  ë³€ê²½ì‚¬í•­ ë°˜ì˜) - ì¼ì›í™”ëœ rerun í¬ì¸íŠ¸
    if st.session_state.need_rerun:
        print("Need rerun flag detected, rerunning UI...")
        st.session_state.need_rerun = False
        st.rerun()

# í…ìŠ¤íŠ¸ ë°ì´í„°ë¥¼ í‘œì‹œìš©ìœ¼ë¡œ ì²˜ë¦¬í•˜ëŠ” í•¨ìˆ˜
def process_text_for_display(text_data):
    """
    í…ìŠ¤íŠ¸ ë°ì´í„°ë¥¼ í‘œì‹œìš©ìœ¼ë¡œ ì²˜ë¦¬í•˜ëŠ” í•¨ìˆ˜
    
    Args:
        text_data: ì²˜ë¦¬í•  í…ìŠ¤íŠ¸ ë˜ëŠ” ë°ì´í„°
        
    Returns:
        ì²˜ë¦¬ëœ í…ìŠ¤íŠ¸
    """
    # í…ìŠ¤íŠ¸ ë°ì´í„°ê°€ ë¬¸ìì—´ì´ ì•„ë‹Œ ê²½ìš° ë¬¸ìì—´ë¡œ ë³€í™˜
    if not isinstance(text_data, str):
        text_data = str(text_data)
    
    return text_data

def add_message(role, content, avatar=None):
    """
    ë©”ì‹œì§€ë¥¼ ì„¸ì…˜ ìƒíƒœì— ì¶”ê°€í•˜ëŠ” í†µí•© í•¨ìˆ˜ (UIì— ì§ì ‘ í‘œì‹œí•˜ì§€ ì•ŠìŒ)
    
    Args:
        role (str): ë©”ì‹œì§€ ì—­í•  ('user', 'assistant')
        content (str): ë©”ì‹œì§€ ë‚´ìš©
        avatar (str, optional): ì•„ë°”íƒ€ ì´ëª¨ì§€
    """
    # ë””ë²„ê¹… ë¡œê·¸ ì¶”ê°€
    print(f"Adding message - Role: {role}, Avatar: {avatar}, Content preview: {content[:50]}...")
    
    # ì‹œìŠ¤í…œ ë©”ì‹œì§€ëŠ” ì¤‘ë³µ ë°©ì§€, í˜ë¥´ì†Œë‚˜ ì‘ë‹µì€ í•­ìƒ ì¶”ê°€
    is_system_message = avatar in ["âš™ï¸", "âš ï¸", "â„¹ï¸"]
    
    # ì¤‘ë³µ ë©”ì‹œì§€ ë°©ì§€ (ì‹œìŠ¤í…œ ë©”ì‹œì§€ë§Œ ì¤‘ë³µ ê²€ì‚¬)
    if is_system_message and any(msg.get("role") == role and msg.get("content") == content for msg in st.session_state.messages):
        print("Message already exists in session_state.messages, skipping...")
        return
        
    # ë©”ì‹œì§€ ì„¸ì…˜ ìƒíƒœì— ì¶”ê°€
    st.session_state.messages.append({
        "role": role,
        "content": content,
        "avatar": avatar
    })
    print(f"Message added, current message count: {len(st.session_state.messages)}")

def show_system_message(message_key, rerun=False):
    """
    ì‹œìŠ¤í…œ ì•ˆë‚´ ë©”ì‹œì§€ë¥¼ ì„¸ì…˜ ìƒíƒœì— ì¶”ê°€í•©ë‹ˆë‹¤
    
    Args:
        message_key (str): ë©”ì‹œì§€ í‚¤
        rerun (bool, optional): ë©”ì‹œì§€ ì¶”ê°€ í›„ UI ì—…ë°ì´íŠ¸ ì—¬ë¶€
    """
    # ì•ˆì „í•˜ê²Œ ë©”ì‹œì§€ ê°€ì ¸ì˜¤ê¸°
    message_content = SYSTEM_MESSAGES.get(message_key)
    if message_content:
        # ë””ë²„ê¹… ë¡œê·¸ ì¶”ê°€
        print(f"Showing system message: {message_key} - {message_content[:50]}...")
        
        add_message("system", message_content, avatar="â„¹ï¸")
        if rerun:
            st.rerun()
    else:
        print(f"ê²½ê³ : ì‹œìŠ¤í…œ ë©”ì‹œì§€ í‚¤ '{message_key}'ê°€ ì •ì˜ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")

if __name__ == "__main__":
    main()